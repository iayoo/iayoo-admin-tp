
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/static/component/pear/css/pear.css" />
</head>
<body class="pear-container">

{include file="layui/table" /}

{block name="datatable-extend"}{/block}

<script src="/static/component/layui/layui.js"></script>
<script src="/static/component/pear/pear.js"></script>
<script>
    layui.use(['table','form','treetable', 'jquery'],function () {
        let table = layui.table;
        let form = layui.form;
        let treetable = layui.treetable;
        let $ = layui.jquery;

        let MODULE_PATH = "{$datatableUrl}";

        let renderConfig = {:htmlspecialchars_decode($renderConfig)};

        window.render = function(){
            treetable.render(renderConfig);
        }

        render();

        table.on('tool(power-table)',function(obj){
            if (obj.event === 'remove') {
                window.remove(obj);
            } else if (obj.event === 'edit') {
                window.edit(obj);
            }
        })

        //弹出窗设置 自己设置弹出百分比
        function screen() {
            if (typeof width !== 'number' || width === 0) {
                width = $(window).width() * 0.8;
            }
            if (typeof height !== 'number' || height === 0) {
                height = $(window).height() - 20;
            }
            return [width + 'px', height + 'px'];
        }

        table.on('toolbar(power-table)', function(obj){
            if(obj.event === 'add'){
                layer.open({
                    type: 2,
                    maxmin: true,
                    title: '新增菜单',
                    shade: 0.1,
                    area: screen(),
                    content: '{:url("add")}'
                });
            } else if(obj.event === 'expandAll'){
                treetable.expandAll("#power-table");
            } else if(obj.event === 'foldAll'){
                treetable.foldAll("#power-table");
            }
        });
        window.edit = function(obj){
            layer.open({
                type: 2,
                maxmin: true,
                title: '修改菜单',
                shade: 0.1,
                area: screen(),
                content: "{:url('/admin/administrator.permission/edit/id',[],false)}/" + obj.data['id']
                //content: MODULE_PATH + 'edit/id/'+obj.data['id']

            });
        }
        window.remove = function(obj){
            layer.confirm('确定要删除该菜单', {
                icon: 3,
                title: '提示'
            }, function(index) {
                layer.close(index);
                let loading = layer.load();
                $.ajax({
                    url:"{:url('remove')}",
                    data:{id:obj.data['id']},
                    dataType: 'json',
                    type: 'POST',
                    success: function(res) {
                        layer.close(loading);
                        //判断有没有权限
                        if(res && res.code==999){
                            layer.msg(res.msg, {
                                icon: 5,
                                time: 2000,
                            })
                            return false;
                        }else if (res.code==200) {
                            layer.msg(res.msg, {
                                icon: 1,
                                time: 1000
                            }, function() {
                                top.location.reload();
                            });
                        } else {
                            layer.confirm(res.msg, {
                                icon: 3,
                                title: '提示'
                            }, function(index) {
                                layer.close(index);
                                let loading = layer.load();
                                $.ajax({
                                    url:MODULE_PATH + 'remove',
                                    data:{id:obj.data['id'],type:true},
                                    dataType: 'json',
                                    type: 'POST',
                                    success: function(res) {
                                        layer.close(loading);
                                        //判断有没有权限
                                        if(res && res.code==999){
                                            layer.msg(res.msg, {
                                                icon: 5,
                                                time: 2000,
                                            })
                                            return false;
                                        }else if (res.code==200) {
                                            layer.msg(res.msg, {
                                                icon: 1,
                                                time: 1000
                                            }, function() {
                                                top.location.reload();
                                            });
                                        }
                                    }
                                })
                            });
                        }
                    }
                })
            });
        }
        form.on('switch(status)', function(data) {
            var status = data.elem.checked?1:2;
            var id = this.value;
            var load = layer.load();
            $.post(MODULE_PATH + 'status',{status:status,id:id},function (res) {
                layer.close(load);
                if (res.code==200){
                    layer.msg(res.msg,{icon:1,time:1500})
                } else {
                    layer.msg(res.msg,{icon:2,time:1500},function () {
                        $(data.elem).prop('checked',!$(data.elem).prop('checked'));
                        form.render()
                    })
                }
            })
        });
    })
</script>
</body>
</html>
